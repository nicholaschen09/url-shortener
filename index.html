<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-2xl">
        <h1 class="text-3xl font-bold text-center mb-2">URL Shortener</h1>
        <p class="text-center text-gray-500 mb-8">Create short, memorable links for your long URLs</p>
        <form id="shortenForm" class="flex flex-col gap-4">
            <div class="flex gap-2">
                <input type="url" id="url" placeholder="Paste your long URL here" required autocomplete="off"
                    class="flex-1 rounded-l-lg border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <button type="button" id="clearUrlBtn"
                    class="rounded-r-lg bg-gray-200 px-4 py-2 text-gray-600 hover:bg-gray-300 transition">Clear</button>
            </div>
            <button type="submit"
                class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition">Shorten
                URL</button>
        </form>
        <div id="result" class="mt-6 hidden">
            <div class="flex items-center bg-gray-100 rounded-lg px-6 py-4">
                <span class="text-lg font-medium mr-2">Your shortened URL:</span>
                <div class="flex items-center flex-1 min-w-0">
                    <a id="shortUrlLink" href="#" target="_blank" rel="noopener"
                        class="text-blue-600 underline truncate"></a>
                    <button id="copyBtn" class="ml-3 p-2 rounded hover:bg-blue-100 transition"
                        title="Copy to clipboard">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5 text-blue-600">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <div id="error" class="hidden mt-4 text-red-600 text-center"></div>
        <div id="successMessage" class="hidden mt-2 text-green-600 text-center">URL copied to clipboard!</div>
    </div>
    <script>
        const form = document.getElementById('shortenForm');
        const urlInput = document.getElementById('url');
        const resultDiv = document.getElementById('result');
        const shortUrlLink = document.getElementById('shortUrlLink');
        const copyBtn = document.getElementById('copyBtn');
        const errorDiv = document.getElementById('error');
        const successMessage = document.getElementById('successMessage');
        const clearUrlBtn = document.getElementById('clearUrlBtn');

        function showResult(shortUrl) {
            if (shortUrl && /^https?:\/\//.test(shortUrl)) {
                shortUrlLink.href = shortUrl;
                shortUrlLink.textContent = shortUrl;
                resultDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');
                localStorage.setItem('shortener_last_result', shortUrl);
            } else {
                resultDiv.classList.add('hidden');
                errorDiv.textContent = 'No valid short URL found in response.';
                errorDiv.classList.remove('hidden');
                localStorage.removeItem('shortener_last_result');
            }
        }

        copyBtn.addEventListener('click', () => {
            const url = shortUrlLink.href;
            navigator.clipboard.writeText(url).then(() => {
                successMessage.classList.remove('hidden');
                setTimeout(() => successMessage.classList.add('hidden'), 2000);
            });
        });

        clearUrlBtn.addEventListener('click', () => {
            urlInput.value = '';
            localStorage.removeItem('shortener_last_url');
            resultDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            localStorage.removeItem('shortener_last_result');
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = urlInput.value;
            localStorage.setItem('shortener_last_url', url);
            errorDiv.classList.add('hidden');
            resultDiv.classList.add('hidden');
            try {
                const response = await fetch('/shorten', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `url=${encodeURIComponent(url)}`
                });
                if (response.ok) {
                    const text = await response.text();
                    let match = text.match(/https?:\/\/[^\s]+/);
                    let shortUrl = match ? match[0] : '';
                    showResult(shortUrl);
                } else {
                    const errorText = await response.text();
                    errorDiv.textContent = errorText || 'Failed to shorten URL';
                    errorDiv.classList.remove('hidden');
                    localStorage.removeItem('shortener_last_result');
                }
            } catch {
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.classList.remove('hidden');
                localStorage.removeItem('shortener_last_result');
            }
        });

        // Restore state from localStorage
        window.addEventListener('DOMContentLoaded', () => {
            const savedUrl = localStorage.getItem('shortener_last_url');
            if (savedUrl) urlInput.value = savedUrl;
            const savedResult = localStorage.getItem('shortener_last_result');
            if (savedResult) showResult(savedResult);
        });
    </script>
</body>

</html>